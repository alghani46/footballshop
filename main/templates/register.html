{% extends 'base.html' %}
{% block title %}Register{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="card shadow p-4">
      <h2 class="mb-3">Register</h2>

      <form id="registerForm" method="POST" action="{% url 'main:register' %}" novalidate>
        {% csrf_token %}
        {{ form.as_p }}
        <div id="registerError" class="alert alert-danger d-none mt-2"></div>
        <button type="submit" class="btn btn-primary w-100">Create account</button>
      </form>

      <p class="mt-3">Already have an account? <a href="{% url 'main:login' %}">Back to Login</a></p>
    </div>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('registerForm');
  const err  = document.getElementById('registerError');
  const CSRF = (document.cookie.match(/(^|;)\s*csrftoken=([^;]+)/)||[])[2] || '';

  if(!form) return;

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (err){ err.classList.add('d-none'); err.textContent=''; }

    try{
      const res = await fetch("{% url 'main:register_ajax' %}", {
        method:'POST',
        headers:{'X-CSRFToken': CSRF},
        body: new FormData(form),
      });
      const data = await res.json();

      if(!res.ok || !data.ok){
        const msg = data.errors
          ? Object.entries(data.errors).map(([k,v]) => `${k}: ${[].concat(v).join(', ')}`).join(' | ')
          : (data.error || 'Registration failed');
        showToast?.('Register failed', msg, 'error', 6000);
        if (err){ err.textContent = msg; err.classList.remove('d-none'); }
        return;
      }

      sessionStorage.setItem('pendingToast', JSON.stringify({
        title:'Account created', message:'You can log in now.', type:'success', duration:6000
      }));
      window.location.href = "{% url 'main:login' %}";
    }catch(_){
      showToast?.('Register failed','Network error. Try again.','error',6000);
      if (err){ err.textContent = 'Network error. Try again.'; err.classList.remove('d-none'); }
    }
  });
})();
</script>
{% endblock %}
