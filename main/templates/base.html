{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  {% block meta %}{% endblock meta %}
  <title>{% block title %}Football Shop{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/global.css' %}">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold text-success" href="{% url 'main:home' %}">Football Shop</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-center">
          {% if user.is_authenticated %}
            <li class="nav-item text-end navbar-student-info me-3">
              <div>{{ student_name }}</div>
              <div>{{ student_class }} - {{ student_npm }}</div>
            </li>
            <!-- optional classic add page -->
            <li class="nav-item"><a class="nav-link" href="{% url 'main:add_product' %}">Add Product</a></li>
            <li class="nav-item">
              <!-- AJAX logout -->
              <a class="nav-link text-danger" href="#" id="logoutLink">Logout</a>
            </li>
          {% else %}
            <li class="nav-item"><a class="nav-link" href="{% url 'main:login' %}">Login</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'main:register' %}">Register</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    {% block content %}{% endblock %}
  </div>

  <!-- Load Bootstrap first -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Then components -->
  {% include 'toast.html' %}
  {% include 'modal.html' %}

  <!-- Cross-page toast + AJAX logout -->
  <script>
  (function(){
    // ----- pending toast (for redirects) -----
    try {
      const raw = sessionStorage.getItem('pendingToast');
      if (raw) {
        const cfg = JSON.parse(raw);
        if (typeof showToast === 'function') {
          showToast(cfg.title, cfg.message, cfg.type || 'info', cfg.duration || 4500);
        }
        sessionStorage.removeItem('pendingToast');
      }
    } catch(_) {}

    // ----- AJAX logout -----
    const link = document.getElementById('logoutLink');
    if (link) {
      link.addEventListener('click', async (e)=>{
        e.preventDefault();
        const m = document.cookie.match(/(^|;)\s*csrftoken=([^;]+)/);
        const CSRF = m ? m[2] : '';
        try{
          const res = await fetch("{% url 'main:logout_ajax' %}", { method:'POST', headers:{'X-CSRFToken': CSRF} });
          const data = await res.json();
          if(!res.ok || !data.ok) throw new Error();
          sessionStorage.setItem('pendingToast', JSON.stringify({
            title:'Logged out', message:'See you soon!', type:'success', duration:4500
          }));
          window.location.href = "{% url 'main:login' %}";
        }catch(_){
          showToast?.('Logout failed','Try again.','error',4500);
        }
      });
    }
  })();
  </script>
</body>
</html>
